---
- name: Install & configure Osquery,filebeat
  hosts: all
  become: yes
  tasks:
# https://docs.ansible.com/ansible/latest/modules/yum_repository_module.html
  - name: Install & configure Osquery
    block:
    - name: Add Server repository
      yum_repository:
        name: 'osquery-s3-rpm'
        description: 'name=osquery RPM repository - x86_64'
        baseurl: 'https://s3.amazonaws.com/osquery-packages/rpm/$basearch/'
        gpgkey: 'https://pkg.osquery.io/rpm/GPG'
        gpgcheck: yes
        repo_gpgcheck: no 
        state: present    
    - name: Install Osquery 
      ansible.builtin.yum:
        name: osquery-4.9.0
        state: present
    - name: Copy osquery.conf file to /etc/osquery/osquery.conf
      ansible.builtin.copy:
        src: osquery.conf
        dest: /etc/osquery
        owner: root
        group: root
        mode: 0644           
    - name: Make sure osquery autostarts
      service:
        name: osqueryd
        enabled: yes
    - name: Restart osquery
      service:
        name: osqueryd
        state: restarted
    when:
    - ansible_os_family == 'RedHat'  
  - name: Install & configure filebeat
    block:
    - name: Install Osquery 
      ansible.builtin.yum:
        name: https://artifacts.elastic.co/downloads/beats/filebeat/filebeat-7.17.0-x86_64.rpm
        state: present
    - name: Copy osquery.conf file to /etc/osquery/osquery.conf
      ansible.builtin.copy:
        src: osquery.conf
        dest: /etc/osquery
        owner: root
        group: root
        mode: 0644           
    - name: Make sure osquery autostarts
      service:
        name: osqueryd
        enabled: yes
    - name: Restart osquery
      service:
        name: osqueryd
        state: restarted
    when:
    - ansible_os_family == 'RedHat'  


